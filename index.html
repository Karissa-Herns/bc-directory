<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brazosport College Contact Directory</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1C2A33 0%,#283D4A 100%);color:#3C3C3C;padding:20px;min-height:100vh}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:30px;text-align:center}
    .header h1{color:#1C2A33;font-size:2.2em;margin-bottom:8px}
    .header p{color:#666}
    .controls{background:#fff;padding:22px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:22px}
    .search-box{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .search-input{flex:1;min-width:240px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px}
    .search-input:focus{outline:none;border-color:#2E4757}
    .filter-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .filter-label{font-weight:600;color:#1C2A33}
    select{padding:10px 12px;border:2px solid #ddd;border-radius:8px;background:#fff}
    .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.15s;background:#2E4757;color:#fff}
    .btn:hover{background:#1C2A33;transform:translateY(-1px)}
    .stats{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:2px solid #f0f0f0;align-items:center}
    .stat{font-size:14px;color:#666}.stat strong{color:#1C2A33;font-size:18px}
    .last-updated{font-size:12px;color:#999;font-style:italic}
    .debug{font-size:12px;color:#7b8a96;margin-top:8px;word-break:break-all}

    .alphabet-filter{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:2px solid #f0f0f0}
    .letter-btn{padding:6px 10px;border:2px solid #ddd;border-radius:6px;background:#fff;color:#2E4757;font-weight:600;cursor:pointer;transition:.15s;font-size:14px}
    .letter-btn:hover{background:#f0f0f0;border-color:#2E4757}
    .letter-btn.active{background:#2E4757;color:#fff;border-color:#2E4757}

    .contacts-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .contacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .contact{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #74B0D6;transition:.15s}
    .contact:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,.15);border-left-color:#2E4757}
    .name{font-size:1.1em;font-weight:700;color:#1C2A33;margin-bottom:5px;word-wrap:break-word}
    .title{font-size:.9em;color:#2E4757;font-weight:600;margin-bottom:8px;word-wrap:break-word}
    .row{display:flex;gap:8px;margin-bottom:5px;font-size:.9em}
    .label{min-width:80px;font-weight:600;color:#666;flex-shrink:0}
    .value{word-wrap:break-word;overflow-wrap:break-word}
    .value a{color:#2E4757;text-decoration:none}
    .value a:hover{text-decoration:underline;color:#74B0D6}

    .state{text-align:center;padding:50px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #2E4757;border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;margin:0 auto 12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @media (max-width:768px){.contacts-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üêä Brazosport College Contact Directory</h1>
      <p>Directory loaded from GAL.csv on GitHub</p>
    </div>

    <div class="controls">
      <div class="search-box">
        <input id="searchInput" class="search-input" placeholder="Search by name, email, title, or department..." />
        <button id="refreshBtn" class="btn">Refresh Data</button>
        <button id="downloadBtn" class="btn">Download CSV</button>
      </div>
      <div class="filter-row">
        <span class="filter-label">Filter by:</span>
        <select id="departmentFilter"><option value="">All Departments</option></select>
        <select id="titleFilter"><option value="">All Job Titles</option></select>
      </div>
      <div class="alphabet-filter" id="alphabetFilter"></div>
      <div class="stats">
        <div class="stat">Showing <strong id="displayCount">0</strong> of <strong id="totalCount">0</strong> contacts</div>
        <div id="lastUpdated" class="last-updated"></div>
      </div>
      <div id="debug" class="debug"></div>
    </div>

    <div id="contactsContainer" class="contacts-card">
      <div class="state"><div class="spinner"></div>Loading‚Ä¶</div>
    </div>
  </div>

  <script>
  // Try relative path first (works with GitHub Pages), fallback to raw GitHub URL
  function getDataUrls() {
    // Add timestamp to bust cache
    const timestamp = new Date().getTime();
    return [
      `./GAL.csv?v=${timestamp}`,
      `GAL.csv?v=${timestamp}`,
      `https://raw.githubusercontent.com/Karissa-Herns/bc-directory/main/GAL.csv?v=${timestamp}`
    ];
  }

  let allContacts = [];
  let filteredContacts = [];
  let selectedLetter = "";

  const $ = id => document.getElementById(id);
  const escapeHtml = s => (s||"").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  const escapeAttr = s => (s||"").toString().replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  function updateLastUpdatedDisplay(){
    const last = localStorage.getItem("bcContactsLastUpdated");
    if(last) $('lastUpdated').textContent = `Last updated: ${last}`;
  }

  function parseCSV(csvText){
    csvText = csvText.replace(/^\uFEFF/, "");
    const lines = csvText.trim().split(/\r?\n/);
    const splitCsvLine = (line) => {
      const result = [];
      let current = "", inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"' && line[i + 1] === '"'){ current += '"'; i++; }
        else if (ch === '"'){ inQuotes = !inQuotes; }
        else if (ch === ',' && !inQuotes){ result.push(current); current = ""; }
        else current += ch;
      }
      result.push(current);
      return result.map(v => v.trim());
    };

    const headers = splitCsvLine(lines[0]);
    const contacts = [];

    for (let i = 1; i < lines.length; i++) {
      const row = splitCsvLine(lines[i]);
      if (!row.length || row.every(v => !v.trim())) continue;
      const obj = {};
      headers.forEach((h, j) => obj[h] = (row[j] || "").replace(/^"|"$/g, "").trim());
      contacts.push(obj);
    }

    return contacts.map(c => ({
      Name: `${c.FirstName || ""} ${c.LastName || ""}`.trim(),
      Email: c.Email || "",
      JobTitle: c.JobTitle || "",
      Department: c.Department || "",
      OfficeLocation: c.OfficeLocation || "",
      BusinessPhone: c.BusinessPhone || "",
      ManagerName: c.ManagerName || ""
    }));
  }

  function initializeFilters(){
    const depts = [...new Set(allContacts.map(c => c.Department).filter(Boolean))].sort();
    const titles = [...new Set(allContacts.map(c => c.JobTitle).filter(Boolean))].sort();
    $('departmentFilter').innerHTML =
      '<option value="">All Departments</option>' +
      depts.map(d => `<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join('');
    $('titleFilter').innerHTML =
      '<option value="">All Job Titles</option>' +
      titles.map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join('');

    // Create alphabet filter
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const alphabetHtml = alphabet.map(letter =>
      `<button class="letter-btn" data-letter="${letter}" onclick="filterByLetter('${letter}')">${letter}</button>`
    ).join('');
    $('alphabetFilter').innerHTML = alphabetHtml;
  }

  function filterByLetter(letter) {
    // Toggle letter selection
    if (selectedLetter === letter) {
      selectedLetter = "";
    } else {
      selectedLetter = letter;
    }

    // Update button states
    document.querySelectorAll('.letter-btn').forEach(btn => {
      if (btn.dataset.letter === selectedLetter) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    applyFilters();
  }

  function applyFilters(){
    const q = $('searchInput').value.toLowerCase();
    const d = $('departmentFilter').value;
    const t = $('titleFilter').value;

    filteredContacts = allContacts.filter(c => {
      const matchesSearch = !q ||
        (c.Name && c.Name.toLowerCase().includes(q)) ||
        (c.Email && c.Email.toLowerCase().includes(q)) ||
        (c.JobTitle && c.JobTitle.toLowerCase().includes(q)) ||
        (c.Department && c.Department.toLowerCase().includes(q));
      const matchesDept = !d || c.Department === d;
      const matchesTitle = !t || c.JobTitle === t;

      // Filter by last name starting letter
      const matchesLetter = !selectedLetter ||
        (c.Name && c.Name.trim().split(' ').pop()[0].toUpperCase() === selectedLetter);

      return matchesSearch && matchesDept && matchesTitle && matchesLetter;
    });
    renderContacts();
  }

  function renderContacts(){
    $('displayCount').textContent = filteredContacts.length;
    $('totalCount').textContent = allContacts.length;
    const container = $('contactsContainer');
    if(!allContacts.length) return;

    // Check if any filter is active
    const q = $('searchInput').value.toLowerCase();
    const d = $('departmentFilter').value;
    const t = $('titleFilter').value;
    const hasActiveFilter = q || d || t || selectedLetter;

    // If no filter is active, show instruction message
    if (!hasActiveFilter) {
      container.innerHTML = `<div class="state">
        <strong>Welcome to the Brazosport College Directory</strong>
        <div class="last-updated" style="margin-top:16px;">To view contacts, please:</div>
        <div class="last-updated">‚Ä¢ Type a search term above</div>
        <div class="last-updated">‚Ä¢ Select a department or job title</div>
        <div class="last-updated">‚Ä¢ Click a letter below to browse by last name</div>
      </div>`;
      return;
    }

    if(!filteredContacts.length){
      container.innerHTML = `<div class="state"><strong>No contacts found</strong><div class="last-updated">Try adjusting your search or filters.</div></div>`;
      return;
    }

    const cards = filteredContacts.map(c => {
      // Filter out placeholder phone numbers
      const hasValidPhone = c.BusinessPhone && c.BusinessPhone !== "000-0000" && !c.BusinessPhone.includes("000-0000");

      return `
      <div class="contact">
        <div class="name">${escapeHtml(c.Name || "No name")}</div>
        ${c.JobTitle ? `<div class="title">${escapeHtml(c.JobTitle)}</div>` : ""}
        <div>
          ${c.Email ? `<div class="row"><div class="label">Email</div><div class="value"><a href="mailto:${escapeAttr(c.Email)}">${escapeHtml(c.Email)}</a></div></div>` : ""}
          ${c.Department ? `<div class="row"><div class="label">Dept</div><div class="value">${escapeHtml(c.Department)}</div></div>` : ""}
          ${c.OfficeLocation ? `<div class="row"><div class="label">Office</div><div class="value">${escapeHtml(c.OfficeLocation)}</div></div>` : ""}
          ${hasValidPhone ? `<div class="row"><div class="label">Phone</div><div class="value"><a href="tel:${escapeAttr(c.BusinessPhone)}">${escapeHtml(c.BusinessPhone)}</a></div></div>` : ""}
          ${c.ManagerName ? `<div class="row"><div class="label">Manager</div><div class="value">${escapeHtml(c.ManagerName)}</div></div>` : ""}
        </div>
      </div>`;
    }).join('');

    container.innerHTML = `<div class="contacts-grid">${cards}</div>`;
  }

  async function loadContacts(){
    const container = $('contactsContainer');
    const debugDiv = $('debug');
    container.innerHTML = `<div class="state"><div class="spinner"></div>Loading contacts‚Ä¶</div>`;

    let lastError = null;
    const DATA_URLS = getDataUrls(); // Get fresh URLs with cache-busting timestamp

    // Try each URL until one works
    for (let i = 0; i < DATA_URLS.length; i++) {
      const url = DATA_URLS[i];
      try {
        debugDiv.textContent = `Trying to load from: ${url}`;
        const res = await fetch(url);
        if(!res.ok) {
          lastError = new Error(`HTTP ${res.status}: ${res.statusText}`);
          debugDiv.textContent = `Failed to load from ${url}: ${lastError.message}`;
          continue;
        }
        const csvText = await res.text();
        allContacts = parseCSV(csvText);

        if (allContacts.length === 0) {
          lastError = new Error("CSV file is empty or invalid");
          debugDiv.textContent = `Loaded from ${url} but CSV is empty`;
          continue;
        }

        // Success!
        debugDiv.textContent = `Successfully loaded ${allContacts.length} contacts from: ${url}`;
        initializeFilters();
        // Show welcome message instead of all contacts
        $('displayCount').textContent = '0';
        $('totalCount').textContent = allContacts.length;
        $('contactsContainer').innerHTML = `<div class="state">
          <strong>Welcome to the Brazosport College Directory</strong>
          <div class="last-updated" style="margin-top:16px;">To view contacts, please:</div>
          <div class="last-updated">‚Ä¢ Type a search term above</div>
          <div class="last-updated">‚Ä¢ Select a department or job title</div>
          <div class="last-updated">‚Ä¢ Click a letter below to browse by last name</div>
        </div>`;
        localStorage.setItem("bcContactsLastUpdated", new Date().toLocaleString());
        updateLastUpdatedDisplay();
        return;
      } catch(e){
        lastError = e;
        debugDiv.textContent = `Error loading from ${url}: ${e.message}`;
        // Continue to next URL
      }
    }

    // All URLs failed
    container.innerHTML = `<div class="state">
      <div style="color:#b00020;font-weight:700;margin-bottom:6px;">Could not load contacts</div>
      <div class="last-updated">${escapeHtml(lastError?.message || "Unknown error")}</div>
      <div class="last-updated" style="margin-top:12px;">To use this page:</div>
      <div class="last-updated">1. Enable GitHub Pages in repository settings, OR</div>
      <div class="last-updated">2. Serve this page using a local web server</div>
    </div>`;
    debugDiv.textContent = `All URLs failed. Last error: ${lastError?.message}`;
  }

  function downloadCSV() {
    // Use filtered contacts if any filters are active, otherwise use all contacts
    const q = $('searchInput').value.toLowerCase();
    const d = $('departmentFilter').value;
    const t = $('titleFilter').value;
    const hasActiveFilter = q || d || t || selectedLetter;

    const contactsToExport = hasActiveFilter && filteredContacts.length > 0 ? filteredContacts : allContacts;

    if (contactsToExport.length === 0) {
      alert('No contacts to download. Please load data first or apply filters.');
      return;
    }

    // Create CSV header
    const headers = ['FirstName', 'LastName', 'Email', 'JobTitle', 'Department', 'OfficeLocation', 'BusinessPhone', 'ManagerName'];
    let csvContent = headers.join(',') + '\n';

    // Add each contact as a row
    contactsToExport.forEach(contact => {
      const nameParts = contact.Name.trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      const row = [
        escapeCSVField(firstName),
        escapeCSVField(lastName),
        escapeCSVField(contact.Email),
        escapeCSVField(contact.JobTitle),
        escapeCSVField(contact.Department),
        escapeCSVField(contact.OfficeLocation),
        escapeCSVField(contact.BusinessPhone),
        escapeCSVField(contact.ManagerName)
      ];
      csvContent += row.join(',') + '\n';
    });

    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    const filename = hasActiveFilter
      ? `bc-directory-filtered-${new Date().toISOString().split('T')[0]}.csv`
      : `bc-directory-all-${new Date().toISOString().split('T')[0]}.csv`;

    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function escapeCSVField(field) {
    if (field == null) return '';
    const str = field.toString();
    // If field contains comma, quote, or newline, wrap in quotes and escape quotes
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  }

  $('searchInput').addEventListener('input', applyFilters);
  $('departmentFilter').addEventListener('change', applyFilters);
  $('titleFilter').addEventListener('change', applyFilters);
  $('refreshBtn').addEventListener('click', loadContacts);
  $('downloadBtn').addEventListener('click', downloadCSV);

  window.addEventListener('load', ()=>{
    updateLastUpdatedDisplay();
    loadContacts();
  });
  </script>
</body>
</html>
